<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pok√©mon Tycoon Multiplayer</title>
<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: url('https://images.squarespace-cdn.com/content/v1/613ef8a0a3de987d28d14431/1662051124297-VAO30XSO47Z7HPVSYSEV/Pokemon_SV_Worldmap.jpg') no-repeat center center fixed;
  background-size: cover;
  overflow: hidden;
  height: 100vh;
}

#top {
  background: rgba(255,255,255,0.9);
  padding: 10px;
  font-size: 20px;
  position: fixed;
  width: 100%;
  top: 0;
  z-index: 1000;
}

#shop {
  background: rgba(238,238,238,0.9);
  padding: 10px;
  position: fixed;
  top: 50px;
  width: 100%;
  z-index: 1000;
}

.pokemon {
  position: absolute;
  width: 96px;
  transition: transform 1s linear;
}

.shiny {
  filter: hue-rotate(120deg) brightness(1.2);
}

button {
  font-size: 12px;
  margin-top: 2px;
}

#adminPanel {
  background: #ffc;
  padding: 10px;
  display: none;
  margin-top: 10px;
  border: 2px solid #cc0;
  position: fixed;
  top: 100px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 1000;
}

#farm {
  width: 100%;
  height: 100%;
  position: relative;
  overflow: hidden;
  margin-top: 160px;
}

#chatPanel {
  position: fixed;
  bottom: 0;
  right: 0;
  width: 250px;
  height: 300px;
  background: rgba(255,255,255,0.9);
  overflow-y: auto;
  padding: 5px;
  font-size: 14px;
}

#chatInput {
  width: 80%;
}

#playersPanel {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 250px;
  height: 200px;
  background: rgba(255,255,255,0.9);
  overflow-y: auto;
  padding: 5px;
  font-size: 14px;
}

#pokemonInfo {
  margin-top: 5px;
  font-size: 14px;
}
</style>
</head>
<body>

<div id="top">
  üí∞ Money: $<span id="money">50</span>
</div>

<div id="shop">
  <input id="search" placeholder="Search Pok√©mon (name or ID)" oninput="showPokemonInfo()">
  <button onclick="buyPokemon()">Buy Pok√©mon</button>
  <button onclick="resetGame()">Reset Game</button>
  <button onclick="unlockAdmin()">Admin Panel</button>
  <div id="pokemonInfo"></div>
</div>

<div id="farm"></div>

<div id="adminPanel">
  <h3>Admin Panel</h3>
  <button onclick="money += 1000; updateMoney(); saveGame()">Add $1000</button>
  <button onclick="resetGame()">Reset Game</button>
  <button onclick="addLegendary()">Add Random Legendary</button>
</div>

<div id="chatPanel">
  <div id="chatMessages"></div>
  <input type="text" id="chatInput" placeholder="Type message">
  <button onclick="sendMessage()">Send</button>
</div>

<div id="playersPanel">
  <h4>Players Online:</h4>
  <ul id="playersList"></ul>
</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
const socket = io("https://your-server-url.com"); // Replace with your Socket.IO server

let money = 50;
let ownedPokemon = [];
let playerId = '';
let username = '';

const EVOLVE_COST = 200;

const RARITY_RULES = {
  common:   { earn: 0.3, shiny: 0.01, cost: 10 },
  uncommon: { earn: 0.7, shiny: 0.02, cost: 30 },
  rare:     { earn: 2, shiny: 0.05, cost: 300 },
  legendary:{ earn: 5, shiny: 0.10, cost: 1000 }
};

// Generate short ID
function generatePlayerId() {
  return Math.random().toString(36).substring(2,8);
}

// Prompt username
function getUsername() {
  username = prompt("Enter your username:");
  if(!username) username = "Player" + Math.floor(Math.random()*1000);
  playerId = generatePlayerId();
  socket.emit('newPlayer', {id: playerId, name: username});
}
getUsername();

// Handle other players
socket.on('playersUpdate', players => {
  const list = document.getElementById('playersList');
  list.innerHTML = '';
  players.forEach(p => {
    const li = document.createElement('li');
    li.textContent = p.name + (p.id === playerId ? " (You)" : "");
    li.onclick = () => offerTrade(p.id);
    list.appendChild(li);
  });
});

// Chat
socket.on('chatMessage', data => {
  const chat = document.getElementById('chatMessages');
  chat.innerHTML += `<div><strong>${data.name}:</strong> ${data.msg}</div>`;
  chat.scrollTop = chat.scrollHeight;
});

function sendMessage() {
  const input = document.getElementById('chatInput');
  if(input.value.trim() === '') return;
  socket.emit('chatMessage', {name: username, msg: input.value});
  input.value = '';
}

// Trades
function offerTrade(targetId) {
  const offerMoney = parseInt(prompt("Offer money (0 if none):")) || 0;
  const offerPokemon = prompt("Offer Pok√©mon name to trade (comma-separated for multiple, leave blank if none):") || '';
  socket.emit('offerTrade', {
    fromId: playerId,
    toId: targetId,
    money: offerMoney,
    pokemon: offerPokemon.split(',').map(p => p.trim()).filter(p => p)
  });
}

socket.on('receiveTrade', trade => {
  const accept = confirm(`Trade from ${trade.fromName}:\nMoney: $${trade.money}\nPok√©mon: ${trade.pokemon.join(', ')}\nAccept?`);
  if(accept) {
    socket.emit('acceptTrade', trade);
    // Adjust local money and pokemon
    money += trade.money;
    trade.pokemon.forEach(pName => {
      const index = ownedPokemon.findIndex(p => p.name.toLowerCase() === pName.toLowerCase());
      if(index >=0) ownedPokemon.splice(index,1);
    });
    updateMoney();
    renderFarm();
    saveGame();
  } else {
    socket.emit('declineTrade', trade);
  }
});

// Rarity function
function getRarity(id) {
  if ((id >= 144 && id <= 151) || (id >= 243 && id <= 251) || (id >= 377 && id <= 386) || id >= 480)
    return "legendary";
  if (id < 200) return "common";
  if (id < 500) return "uncommon";
  return "rare";
}

// Show Pok√©mon info before buying
async function showPokemonInfo() {
  const input = document.getElementById("search").value.toLowerCase().trim();
  const infoDiv = document.getElementById("pokemonInfo");
  if (!input) { infoDiv.textContent = ''; return; }

  try {
    const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${input}`);
    if (!res.ok) { infoDiv.textContent = "Pok√©mon not found"; return; }
    const data = await res.json();
    const rarity = getRarity(data.id);
    const price = RARITY_RULES[rarity].cost;
    const earn = RARITY_RULES[rarity].earn;

    const speciesRes = await fetch(`https://pokeapi.co/api/v2/pokemon-species/${data.id}`);
    const species = await speciesRes.json();
    const evoRes = await fetch(species.evolution_chain.url);
    const evoData = await evoRes.json();

    function countRemainingEvolutions(chain, currentName) {
      if (chain.species.name === currentName) return countChainDepth(chain)-1;
      for (const e of chain.evolves_to) {
        const next = countRemainingEvolutions(e,currentName);
        if(next !== null) return next;
      }
      return 0;
    }
    function countChainDepth(chain) {
      if (!chain.evolves_to.length) return 1;
      return 1 + Math.max(...chain.evolves_to.map(c => countChainDepth(c)));
    }

    const remainingEvos = countRemainingEvolutions(evoData.chain,data.name);

    infoDiv.innerHTML = `
      <strong>${data.name}</strong> (${rarity})<br>
      Price: $${price}<br>
      Income: $${earn.toFixed(2)}/sec<br>
      Evolution stages left: ${remainingEvos}
    `;

  } catch(e) { infoDiv.textContent = "Error fetching Pok√©mon info"; }
}

// Buy Pok√©mon
async function buyPokemon() {
  const input = document.getElementById("search").value.toLowerCase().trim();
  if (!input) return;
  const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${input}`);
  if(!res.ok) return alert("Pok√©mon not found");
  const data = await res.json();
  const rarity = getRarity(data.id);
  const price = RARITY_RULES[rarity].cost;
  if(money < price) return alert(`Not enough money! Cost: $${price}`);
  const shiny = Math.random() < RARITY_RULES[rarity].shiny;
  money -= price; updateMoney();

  const farm = document.getElementById("farm");
  const x = Math.random()*(farm.clientWidth-100);
  const y = Math.random()*(farm.clientHeight-100);

  ownedPokemon.push({
    id: data.id, name: data.name, img: shiny ? data.sprites.front_shiny : data.sprites.front_default,
    earn: RARITY_RULES[rarity].earn, shiny, level: 1, upgradeCost: Math.floor(price/2),
    evolutionsDone:0, maxEvolutions:0, price, x, y
  });

  fetchEvolutionChain(data.id, ownedPokemon.length-1);
  renderFarm(); saveGame();
}

// Fetch evolution chain for max evolutions
async function fetchEvolutionChain(pokemonId,index) {
  const speciesRes = await fetch(`https://pokeapi.co/api/v2/pokemon-species/${pokemonId}`);
  const species = await speciesRes.json();
  const evoRes = await fetch(species.evolution_chain.url);
  const evoData = await evoRes.json();

  function countRemainingEvolutions(chain,currentName){
    if(chain.species.name===currentName)return countChainDepth(chain)-1;
    for(const e of chain.evolves_to){
      const next = countRemainingEvolutions(e,currentName);
      if(next!==null) return next;
    }
    return 0;
  }
  function countChainDepth(chain){
    if(!chain.evolves_to.length) return 1;
    return 1 + Math.max(...chain.evolves_to.map(c=>countChainDepth(c)));
  }

  ownedPokemon[index].maxEvolutions = countRemainingEvolutions(evoData.chain,ownedPokemon[index].name);
  saveGame();
}

// Render farm
function renderFarm(){
  const farm = document.getElementById("farm");
  farm.innerHTML='';
  ownedPokemon.forEach((p,i)=>{
    const div = document.createElement("div");
    div.className = "pokemon"+(p.shiny?" shiny":"");
    div.style.left = p.x+"px";
    div.style.top = p.y+"px";
    const rarity = getRarity(p.id);
    div.innerHTML = `
      <img src="${p.img}">
      <div><strong>${p.name}</strong></div>
      <div>+$${p.earn.toFixed(2)}/sec</div>
      <div>Lvl ${p.level}</div>
      <button onclick="upgradePokemon(${i})">Upgrade ($${p.upgradeCost})</button>
      ${p.evolutionsDone < p.maxEvolutions ? `<button onclick="evolvePokemon(${i})">Evolve ($${EVOLVE_COST})</button>` : ""}
      <button onclick="sellPokemon(${i})">Sell ($${getSellPrice(p)})</button>
    `;
    farm.appendChild(div);
  });
}

// Sell price
function getSellPrice(p){
  const rarity = getRarity(p.id);
  if(rarity==="common") return 10;
  if(rarity==="uncommon") return 30;
  if(rarity==="rare") return 300;
  if(rarity==="legendary") return 1000;
  return 10;
}

// Pok√©mon movement
function movePokemon(){
  const farm = document.getElementById("farm");
  ownedPokemon.forEach(p=>{
    p.x += (Math.random()-0.5)*20;
    p.y += (Math.random()-0.5)*20;
    p.x = Math.max(0,Math.min(p.x,farm.clientWidth-100));
    p.y = Math.max(0,Math.min(p.y,farm.clientHeight-100));
  });
  renderFarm();
}
setInterval(movePokemon,1000);

// Upgrade Pok√©mon
function upgradePokemon(i){
  const p = ownedPokemon[i];
  if(money < p.upgradeCost) return alert("Not enough money!");
  money -= p.upgradeCost;
  p.level++;
  p.earn *= 1.5;
  p.upgradeCost = Math.floor(p.upgradeCost * 1.7);
  updateMoney();
  renderFarm();
  saveGame();
}

// Evolve Pok√©mon
async function evolvePokemon(i){
  const p = ownedPokemon[i];
  if(money<EVOLVE_COST) return alert("Not enough money!");
  const speciesRes = await fetch(`https://pokeapi.co/api/v2/pokemon-species/${p.id}`);
  const species = await speciesRes.json();
  const evoRes = await fetch(species.evolution_chain.url);
  const evoData = await evoRes.json();

  function findNextEvolution(chain,currentName){
    if(chain.species.name===currentName){
      if(chain.evolves_to.length>0) return chain.evolves_to[0].species.name;
      else return null;
    }
    for(const e of chain.evolves_to){
      const next=findNextEvolution(e,currentName);
      if(next) return next;
    }
    return null;
  }

  const nextName = findNextEvolution(evoData.chain,p.name);
  if(!nextName) return alert("No evolution available!");
  const pokeRes = await fetch(`https://pokeapi.co/api/v2/pokemon/${nextName}`);
  const newData = await pokeRes.json();

  money -= EVOLVE_COST;
  p.name = newData.name;
  p.img = p.shiny ? newData.sprites.front_shiny : newData.sprites.front_default;
  p.earn *= 2;
  p.evolutionsDone++;
  p.id = newData.id;
  renderFarm();
  updateMoney();
  saveGame();
}

// Sell Pok√©mon
function sellPokemon(i){
  const p = ownedPokemon[i];
  money += getSellPrice(p);
  ownedPokemon.splice(i,1);
  updateMoney();
  renderFarm();
  saveGame();
}

// Idle earnings
setInterval(()=>{
  ownedPokemon.forEach(p=>money+=p.earn);
  updateMoney();
  saveGame();
},1000);

function updateMoney(){ document.getElementById("money").textContent=Math.floor(money); }
function saveGame(){ localStorage.setItem("pokemonTycoonSave",JSON.stringify({money,ownedPokemon})); }
function loadGame(){
  const save = JSON.parse(localStorage.getItem("pokemonTycoonSave"));
  if(!save) return;
  money=save.money;
  ownedPokemon=save.ownedPokemon;
  updateMoney();
  renderFarm();
}
loadGame();

// Admin panel
function unlockAdmin(){
  const code = prompt("Enter admin code:");
  if(code==="banana fish"){
    document.getElementById("adminPanel").style.display="block";
    alert("Admin panel unlocked!");
  }else{
    alert("Wrong code!");
  }
}

async function addLegendary(){
  const legendaries=[144,145,146,147,148,149,150,151,243,244,245,246,247,248,249,250,251,377,378,379,380,381,382,383,384,385,386];
  const id = legendaries[Math.floor(Math.random()*legendaries.length)];
  const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${id}`);
  const data = await res.json();
  const shiny = Math.random()<0.1;
  const farm = document.getElementById("farm");
  const x = Math.random()*(farm.clientWidth-100);
  const y = Math.random()*(farm.clientHeight-100);
  ownedPokemon.push({
    id: data.id,
    name: data.name,
    img: shiny?data.sprites.front_shiny:data.sprites.front_default,
    earn: RARITY_RULES.legendary.earn,
    shiny,
    level:1,
    upgradeCost:500,
    evolutionsDone:0,
    maxEvolutions:0,
    price: RARITY_RULES.legendary.cost,
    x,y
  });
  fetchEvolutionChain(data.id,ownedPokemon.length-1);
  renderFarm();
  saveGame();
}

// Reset game
function resetGame(){
  if(!confirm("Are you sure you want to reset your game?")) return;
  money=50;
  ownedPokemon=[];
  updateMoney();
  renderFarm();
  saveGame();
}
</script>
</body>
</html>
