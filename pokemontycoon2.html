<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PokÃ©mon Tycoon Multiplayer</title>
<style>
body { margin:0; font-family: Arial, sans-serif; background:url('https://images.squarespace-cdn.com/content/v1/613ef8a0a3de987d28d14431/1662051124297-VAO30XSO47Z7HPVSYSEV/Pokemon_SV_Worldmap.jpg') no-repeat center center fixed; background-size: cover; overflow:hidden; height:100vh;}
#top {background: rgba(255,255,255,0.9); padding:10px; font-size:20px; position:fixed; width:100%; top:0; z-index:1000;}
#shop {background: rgba(238,238,238,0.9); padding:10px; position: fixed; top:50px; width:100%; z-index:1000;}
#farm {width:100%; height:100%; position:relative; overflow:hidden; margin-top:120px;}
.pokemon {position:absolute; width:96px; transition:transform 1s linear;}
.shiny {filter:hue-rotate(120deg) brightness(1.2);}
button {font-size:12px; margin-top:2px;}
#adminPanel {background:#ffc; padding:10px; display:none; margin-top:10px; border:2px solid #cc0; position:fixed; top:100px; left:50%; transform:translateX(-50%); z-index:1000;}
#chat {position:fixed; bottom:0; right:0; width:300px; height:300px; background:rgba(255,255,255,0.9); overflow:auto; padding:5px; z-index:1000;}
#chatInput {position:fixed; bottom:0; right:0; width:240px; padding:5px;}
#onlinePlayers {position:fixed; top:100px; right:10px; background:rgba(255,255,255,0.9); padding:5px; width:200px; max-height:300px; overflow:auto; z-index:1000;}
</style>
</head>
<body>

<div id="top">ðŸ’° Money: $<span id="money">50</span></div>

<div id="shop">
<input id="search" placeholder="Search PokÃ©mon (name or ID)">
<button onclick="buyPokemon()">Buy PokÃ©mon</button>
<button onclick="resetGame()">Reset Game</button>
<button onclick="unlockAdmin()">Admin Panel</button>
</div>

<div id="farm"></div>

<div id="adminPanel">
<h3>Admin Panel</h3>
<button onclick="money+=1000; updateMoney(); saveGame()">Add $1000</button>
<button onclick="resetGame()">Reset Game</button>
<button onclick="addLegendary()">Add Random Legendary</button>
</div>

<div id="chat"></div>
<input id="chatInput" placeholder="Type a message" onkeydown="if(event.key==='Enter') sendMessage()">

<div id="onlinePlayers"><h4>Players Online:</h4><ul id="playerList"></ul></div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();

// prompt for username
let username = prompt("Enter your username:");
if(!username) username="Player"+Math.floor(Math.random()*1000);
socket.emit("newPlayer",{username});

// multiplayer events
socket.on("updatePlayers", players=>{
  const list = document.getElementById("playerList");
  list.innerHTML="";
  players.forEach(p=>list.innerHTML+=`<li>${p.username}</li>`);
});
socket.on("chatMessage", msg=>{
  const chat = document.getElementById("chat");
  chat.innerHTML+=`<div><strong>${msg.username}:</strong> ${msg.message}</div>`;
  chat.scrollTop=chat.scrollHeight;
});
function sendMessage(){
  const input=document.getElementById("chatInput");
  if(input.value.trim()==="") return;
  socket.emit("chatMessage", input.value.trim());
  input.value="";
}
// trade requests
function sendTrade(toPlayerId, offer, request){
  socket.emit("tradeRequest",{toPlayerId, offer, request});
}
socket.on("incomingTrade", data=>{
  if(confirm(`${data.from.username} wants to trade with you! Accept?`)){
    socket.emit("acceptTrade",{fromId:data.from.id, offer:data.trade.offer, request:data.trade.request});
    alert("Trade completed!");
  }
});
socket.on("tradeAccepted", data=>{
  alert("Trade completed with "+data.fromId);
});

// ------------------------------
// Your full PokÃ©mon Tycoon code goes here
// Money, ownedPokemon, buyPokemon(), evolutions, upgrades, admin panel, farm rendering, etc.
// Make sure all previous features stay exactly as they are
// Only change is you can call `sendTrade()` and chat is working
// ------------------------------

let money=50;
let ownedPokemon=[];

const RARITY_RULES={
  common:{earn:0.3, shiny:0.01, cost:10},
  uncommon:{earn:0.7, shiny:0.02, cost:30},
  rare:{earn:2, shiny:0.05, cost:300},
  legendary:{earn:5, shiny:0.1, cost:1000}
};

function getRarity(id){
  if((id>=144 && id<=151)||(id>=243 && id<=251)||(id>=377 && id<=386)||id>=480) return "legendary";
  if(id<200) return "common";
  if(id<500) return "uncommon";
  return "rare";
}

// BUY POKEMON
async function buyPokemon(){
  const input=document.getElementById("search").value.toLowerCase().trim();
  if(!input) return;
  const res=await fetch(`https://pokeapi.co/api/v2/pokemon/${input}`);
  if(!res.ok) return alert("PokÃ©mon not found!");
  const data=await res.json();
  const rarity=getRarity(data.id);
  const price=RARITY_RULES[rarity].cost;
  if(money<price) return alert(`Not enough money! Cost: $${price}`);
  const shiny=Math.random()<RARITY_RULES[rarity].shiny;
  money-=price;
  updateMoney();
  const farm=document.getElementById("farm");
  const x=Math.random()*(farm.clientWidth-100);
  const y=Math.random()*(farm.clientHeight-100);
  ownedPokemon.push({
    id:data.id,
    name:data.name,
    img:shiny?data.sprites.front_shiny:data.sprites.front_default,
    earn:RARITY_RULES[rarity].earn,
    shiny,
    level:1,
    upgradeCost:RARITY_RULES[rarity].cost,
    evolutionsDone:0,
    maxEvolutions:0,
    price,
    x,y
  });
  fetchEvolutionChain(data.id, ownedPokemon.length-1);
  renderFarm();
  saveGame();
}

// EVOLUTION & CHAIN FETCH
async function fetchEvolutionChain(pokemonId,index){
  const speciesRes=await fetch(`https://pokeapi.co/api/v2/pokemon-species/${pokemonId}`);
  const species=await speciesRes.json();
  const evoRes=await fetch(species.evolution_chain.url);
  const evoData=await evoRes.json();

  function countRemainingEvolutions(chain,currentName){
    if(chain.species.name===currentName) return countChainDepth(chain)-1;
    for(const e of chain.evolves_to){
      const next=countRemainingEvolutions(e,currentName);
      if(next!==null) return next;
    }
    return 0;
  }
  function countChainDepth(chain){
    if(!chain.evolves_to.length) return 1;
    return 1+Math.max(...chain.evolves_to.map(c=>countChainDepth(c)));
  }

  ownedPokemon[index].maxEvolutions=countRemainingEvolutions(evoData.chain,ownedPokemon[index].name);
  saveGame();
}

// RENDER FARM
function renderFarm(){
  const farm=document.getElementById("farm");
  farm.innerHTML="";
  ownedPokemon.forEach((p,i)=>{
    const div=document.createElement("div");
    div.className="pokemon"+(p.shiny?" shiny":"");
    div.style.left=p.x+"px";
    div.style.top=p.y+"px";
    div.innerHTML=`
      <img src="${p.img}">
      <div><strong>${p.name}</strong></div>
      <div>+$${p.earn.toFixed(1)}/sec</div>
      <div>Lvl ${p.level}</div>
      <div>Evo ${p.evolutionsDone}/${p.maxEvolutions}</div>
      <div>Buy Price: $${p.price}</div>
      <button onclick="upgradePokemon(${i})">Upgrade ($${p.upgradeCost})</button>
      ${p.evolutionsDone<p.maxEvolutions?`<button onclick="evolvePokemon(${i})">Evolve ($100)</button>`:""}
      <button onclick="sellPokemon(${i})">Sell</button>
    `;
    farm.appendChild(div);
  });
}

// MOVEMENT
function movePokemon(){
  const farm=document.getElementById("farm");
  ownedPokemon.forEach(p=>{
    p.x+=(Math.random()-0.5)*20;
    p.y+=(Math.random()-0.5)*20;
    p.x=Math.max(0,Math.min(p.x,farm.clientWidth-100));
    p.y=Math.max(0,Math.min(p.y,farm.clientHeight-100));
  });
  renderFarm();
}
setInterval(movePokemon,1000);

// UPGRADE
function upgradePokemon(i){
  const p=ownedPokemon[i];
  if(money<p.upgradeCost) return alert("Not enough money!");
  money-=p.upgradeCost;
  p.level++;
  p.earn*=1.5;
  p.upgradeCost=Math.floor(p.upgradeCost*1.7);
  updateMoney();
  renderFarm();
  saveGame();
}

// EVOLVE
async function evolvePokemon(i){
  const EVOLVE_COST=100;
  if(money<EVOLVE_COST) return alert("Not enough money!");
  const p=ownedPokemon[i];
  const speciesRes=await fetch(`https://pokeapi.co/api/v2/pokemon-species/${p.id}`);
  const species=await speciesRes.json();
  const evoRes=await fetch(species.evolution_chain.url);
  const evoData=await evoRes.json();

  function findNextEvolution(chain,currentName){
    if(chain.species.name===currentName){
      if(chain.evolves_to.length>0) return chain.evolves_to[0].species.name;
      else return null;
    }
    for(const e of chain.evolves_to){
      const next=findNextEvolution(e,currentName);
      if(next) return next;
    }
    return null;
  }

  const nextName=findNextEvolution(evoData.chain,p.name);
  if(!nextName) return alert("No evolution available!");
  const pokeRes=await fetch(`https://pokeapi.co/api/v2/pokemon/${nextName}`);
  const newData=await pokeRes.json();
  money-=EVOLVE_COST;
  p.name=newData.name;
  p.img=p.shiny?newData.sprites.front_shiny:newData.sprites.front_default;
  p.earn*=2;
  p.evolutionsDone++;
  p.id=newData.id;
  renderFarm();
  updateMoney();
  saveGame();
}

// SELL
function sellPokemon(i){
  const p=ownedPokemon[i];
  money+=p.earn*10; // just example
  ownedPokemon.splice(i,1);
  updateMoney();
  renderFarm();
  saveGame();
}

// RESET & MONEY
function resetGame(){if(confirm("Reset?")){money=50; ownedPokemon=[]; localStorage.removeItem("pokemonTycoonSave"); updateMoney(); renderFarm();}}
function updateMoney(){document.getElementById("money").textContent=Math.floor(money);}

// IDLE INCOME
setInterval(()=>{ownedPokemon.forEach(p=>money+=p.earn); updateMoney(); saveGame();},1000);

// SAVE/LOAD
function saveGame(){localStorage.setItem("pokemonTycoonSave",JSON.stringify({money,ownedPokemon}));}
function loadGame(){const save=JSON.parse(localStorage.getItem("pokemonTycoonSave")); if(!save) return; money=save.money; ownedPokemon=save.ownedPokemon; updateMoney(); renderFarm();}
loadGame();

// ADMIN
function unlockAdmin(){const code=prompt("Enter admin code:"); if(code==="banana fish"){document.getElementById("adminPanel").style.display="block"; alert("Admin unlocked!");}else{alert("Wrong code!");}}
async function addLegendary(){const leg=[144,145,146,147,148,149,150,151,243,244,245,246,247,248,249,250,251,377,378,379,380,381,382,383,384,385,386]; const id=leg[Math.floor(Math.random()*leg.length)]; const res=await fetch(`https://pokeapi.co/api/v2/pokemon/${id}`); const data=await res.json(); const shiny=Math.random()<0.1; const farm=document.getElementById("farm"); const x=Math.random()*(farm.clientWidth-100); const y=Math.random()*(farm.clientHeight-100); ownedPokemon.push({id:data.id, name:data.name, img:shiny?data.sprites.front_shiny:data.sprites.front_default, earn:RARITY_RULES.legendary.earn, shiny, level:1, upgradeCost:100, evolutionsDone:0, maxEvolutions:0, price:RARITY_RULES.legendary.cost, x,y}); fetchEvolutionChain(data.id,ownedPokemon.length-1); renderFarm(); saveGame();}
</script>
</body>
</html>

